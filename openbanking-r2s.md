# SCA based on OpenID4VP using OpenBanking

## Abstract
Open banking is a financial concept allowing third-party financial service providers to access customer banking data through APIs (Application Programming Interfaces). This innovation enables customers to securely authorize payment or share their financial information with other financial institutions or third-party providers. 

Strong Customer Authentication (SCA) is a crucial requirement under the Revised Payment Service Directive (PSD2) aimed at enhancing the security of electronic payments. To meet SCA standards in open banking, banks must implement multi-factor authentication, typically involving two out of three factors: 

- knowledge (e.g., password or PIN)
- possession (e.g., mobile phone)
- and inherence (e.g., biometrics like fingerprint or facial recognition). 

This additional layer of security is essential to combat fraud in online transactions and protect both financial institutions and consumers. Today there exist multiple ways on how SCA can be performed. 

- **Redirected**: The Redirected SCA approach described in XS2A section 5.1.1[^xs2a] involves redirecting users to their bank's authentication interface during a payment transaction to complete the authorization process. This method presents a pre-populated credit transfer screen for the user's confirmation, making it a semi-automated process where the flow is controlled by the user, initiating the payment themselves Embedded
- **Embedded**: The Embedded SCA approach described in XS2A section 5.1.8[^xs2a] involves a fully automated process where the payment is initiated on behalf of the Payment Service User (PSU) by the Third-Party Provider (TPP). In this method, the user shares their credentials with the TPP, who then authenticates and initiates the payment in the background, embedding the authentication process seamlessly within the transaction flow.
- **Decoupled**: The Decoupled approach described in XS2A section 5.1.7[^xs2a] offers a convenient method to obtain SCA approval with minimal effort from the merchant or cardholder. This approach allows transactions to occur without the cardholder being actively engaged with the merchant's website or mobile application. Instead, authentication is conducted through alternative channels, such as mobile push notifications within banking apps, email, or other methods chosen by the Issuer bank to inform the cardholder of an authentication request from a merchant.

This document is focussing on the option to leverage the OpenID4VP[^openid4vp] and OpenID4VCi[^openid4vci] specifications in order to introduce a standardized approach to allow compatible wallet applications to act as an authentication mean for SCA. 


## Terminology

- **ASPSP**: Account Serving Payment Service Provider 
- **Wallet**: An entity that receives, stores, presents, and manages credentials and key material of the End User. A wallet is defined as a nativ mobile application.
- **Payment credential** : A verifiable credential issued by an ASPSP to a customer. The credential must be cryptographically bound to a private key residing in the wallet.
- **Decentralized Identifier**: An identifier with its core ability being enabling Clients to obtain key material and other metadata by reference, defined in DID Core [^did].
- **Payment request credential**: A self-attested verifiable credential generated by the wallet containing the details for a transaction that needs to be authorized. The credential must always be signed using the private key connected to the Payment credential.

## Disclaimer
In order to make the process and the examples clearer, this document makes some opinionated choices regarding formats, schemas, identifiers etc. which might differ in a complex real world scenario. 

## Flow

Brief description of a payment initation flow using a payment initiation service (PIS) described in XS2A section 5[^xs2a]. Note: Besides payment initiation, the flow can also be used to authorize other kind of transaction like logging into online banking e.g.. 

### Onboarding

Prior to using a wallet as a mean for SCA, it requires an onboarding to exchange a cryptographic key-set between the ASPSP and a customer wallet. The exchange is done by the ASPSP issuing a payment credential using OpenID4VCi [^openid4vci]. 

#### Payment Credential

The payment credential MUST be cryptographically bound to a dedicated private key created by the wallet and used to sign a `proof` while requesting the issuing of a Payment credential as described in OpenID4VCi, section 7.2[^openid4vci]. The `proof` parameter is therefor always REQUIRED.

The `credentialSubject` includes the following properties:

- `id`: REQUIRED. Unique ID of the credential
- `aspsp_name`: RECOMMENDED. Name of the issuing ASPSP.
- `account_alias`: REQUIRED.
- `bic`: REQUIRED. Business Identifier Code of the Bank.


Example of an issued Payment credential.

```json
{
  "iss": "did:jwk:eyJjcnYiOiJQLi...",
  "jti": "dc961165-fb13-4d19-98f0-37c9bb06be",
  "nbf": 1707232027,
  "aud": "EUDIW",
  "nonce": "a2bcc3e0-623d-441d-aa80-31d82aa665d1",
  "sub": "did:jwk:eyJrdHkiOiJFi...",
  "vc": {
    "@context": [
      "https://www.w3.org/2018/credentials/v1",
      "https://w3id.org/security/suites/jws-2020/v1"
    ],
    "type": [
      "VerifiableCredential",
      "PaymentKey"
    ],
    "credentialSubject": {
      "id" : "s4dft5f",
      "aspsp_name": "Super Bank",
      "account_alias": "MyAccount",
      "bic": "DEUTDEFFXXX"
    }
  }
}

```

### Payment

#### Screenflow

Same-device screenflow of the payment process:

![Screenflow](screenflow.svg)

1. Merchant app initiates the process by requesting the presentation of a payment credential.
2. Redirect to wallet. Wallet asking the payer to consent to the presentation of a payment credential. If more than one suitable payment credential is available, they have to choose one. 
    - Consent might include biometrics or PIN.
3. Wallet displays the payment details and asks for content to the presentation.
    - Consent must include biometrics or PIN.
4. Purchase is completed.

#### Present payment credential

```mermaid

sequenceDiagram
    autonumber
    actor payer as Payer
    participant uw as EUDIW Wallet
    participant payee as Payee

    payee ->> uw: Present authorization request URL
    uw ->> payee: HTTP GET authorization request object
    payee ->> uw: HTTP RESP 200 authorization request object

    uw ->> payer: request consent 
    payer ->> uw: consents to presentation
    uw ->> payee: HTTP POST authorization response
    Note over payee: initate payment... 
    payee ->> uw: HTTP RESP 302 authorization response
```

1. The payee requests the presentation of a Payment credential as defined by OpenID4VP[^openid4vp]. The authorization request URL is tranmitted
    - **cross-device** by presenting it as a QR code / NFC Tag or
    - **same-device** by activating a link with a custom URL scheme.
2. `HTTP GET` to load the OpenID4VP authorization request object
3. `HTTP GET 200` response including the OpenID4VP authorization request object. The included `presentation_definition` requests the presentation of a valid payment credential from the wallet.
4. Wallet request consents to present the payment credential from the payer.
5. Payer consents to the presentation.
6. `HTTP POST` OpenID4VP authorization response. The response includes a verifiable presentation of a payment credential. This will trigger the initation of a payment.
    Note over payee: initate payment... 
7. `HTTP POST` 302 Redirect to SCA

#### Payment initiation

```mermaid

sequenceDiagram
    autonumber
    participant uw as EUDIW Wallet
    participant payee as Payee
    participant pisp as PISP
    participant bank as ASPSP Payer

    payee ->> pisp: request to initiate payment 
    pisp ->> bank: payment initiation request
    bank ->> pisp: payment initiation response
    pisp ->> payee: Redirect Link for EUDIW SCA
    payee -->> uw: HTTP 302 Redirect to Link for SCA
    uw ->> bank: Follow redirect

```

1. Once the payee verified the presented payment credential, it initiates a payment using a payment initiation service provider (PISP). The presented Payment credential must be send along with the payment details.
2. The PISP uses the information included in the payment credential to initiate a payment at the payers ASPSP (aka the issuer of the payment credential) utilizing an OpenBanking API payment initiation request.
3. In response, the ASPSP of the payer sends the link to authorize the payment to the PISP.
4. The PISP forwards the authorization link to the merchant.
5. `HTTP 302` The payee forwards the SCA authorization link to the wallet as respone to the presentation of the payment credential.
6. The wallet follows the authorization link to initiate the SCA.


#### SCA payment authorization


```mermaid

sequenceDiagram
    autonumber
    participant payer as Payer
    participant uw as EUDIW Wallet
    participant bank as ASPSP Payer
    
    uw ->> bank: HTTP GET Authorization request object
    bank -->> uw: HTTP 200 Authorization request object
    uw->>payer: Payment details
    payer->> uw: consent
    uw->>uw: sign
    uw->>bank: HTTP POST Authorization response
    bank ->> bank: Verify and execute payment
    bank -->> uw: Authorization response OK

```

1. `HTTP GET` to load the OpenID4VP authorization request for the SCA 
2. `HTTP 200` response including the OpenID4VP authorization request, which must contain
    - the actual payload for the transaction in the `authorization_details` and 
    - the `presentation_definition` requesting the presentation of a self-attested credential that will include the payload from the `authorization_details` as described in Request2sign[^r2s]. 
3. The wallet presents the payment details to the payer. The `input_descriptor` of the `payment_definition` with the `id` `request2sign_input` will also provide a JSON schema the wallet can use to dynamically generate a form to display the content of the `authorization_details` to the payer and ask for consent[^js_an_example].
4. The user consents to the presentation of the payment request credential by providing the first factor like a wallet PIN or biometrics.
5. The wallet creates a payment request credential presentation linked dynamically to the transaction by including the transaction details and signs it using the private key as the second factor.
6. `HTTP POST` including the OpenID4VP authorization response and the verifiable presentation of the self-attested payment request credential.
7. The ASPSP verifies the verfiable presentation of the payment request credential using the public key of the payer and executes the payment.
8. `HTTP 200`  signals the wallet that the verifiable presentation has been received and verified successfully. Depending on the payment rail, it might also indicate the successful execution of a payment.

Example of a complete authorization request object:

```json
{
  "aud": "EUDIW",
  "authorization_details": [
    {
      "type": "request2sign",
      "payload": {
        "instructedAmount": {
          "amount": "5.59",
          "currency": "EUR"
        },
        "paymentIdentification": {
          "endToEndIdentification": "CDF834F4-5CF4-4A27-9C04-9EEB347BF"
        },
        "remittanceInformationUnstructured": [
          "Shopping at Merchant A"
        ],
        "creditor": {
          "additionalPartyInformation": {
            "merchantCallbackUrl": "https://merchant.com/callback"
          },
          "name": "Merchant A"
        },
        "creditorAccount": {
          "iban": "DE88940594210020801890"
        }
      }
    }
  ],
  "client_id": "did:jwk:eyJrdHkiOiJFQ...",
  "client_id_scheme": "did",
  "iss": "did:jwk:eyJrdHkiOiJFQ...",
  "nonce": "CPxpkYdz2ECNwYAx",
  "presentation_definition": {
    "id": "32f54163-7166-48f1-93d8-ff217bdb0653",
    "input_descriptors": [
      {
        "id": "request2sign_input",
        "constraints": {
          "subject_is_issuer": "required",
          "fields": [
            {
              "id": "request2sign_payload",
              "path": [
                "$.credentialSubject.request2sign_payload"
              ],
              "filter": {
                "$schema": "https://json-schema.org/draft/2020-12/schema",
                "type": "object",
                "properties": {
                  "instructedAmount": {
                    "type": "object",
                    "title": "Amount",
                    "properties": {
                      "amount": {
                        "type": "string",
                        "title": "Amount",
                        "description": "Amount to pay"
                      },
                      "currency": {
                        "type": "string",
                        "title": "Currency",
                        "description": "Currency to pay in"
                      }
                    },
                    "required": [
                      "amount",
                      "currency"
                    ]
                  },
                  "transactionID": {
                    "type": "string",
                    "title": "Transaction ID",
                    "description": "Unique transaction identifier"
                  },
                  "purpose": {
                    "type": "string",
                    "title": "Purpose",
                    "description": "Purpose of the transaction"
                  },
                  "creditorAccount": {
                    "type": "object",
                    "title": "Creditor",
                    "properties": {
                      "iban": {
                        "type": "string",
                        "title": "IBAN",
                        "description": "IBAN of the creditor"
                      },
                      "name": {
                        "type": "string",
                        "title": "Name",
                        "description": "Name of the creditor"
                      }
                    },
                    "required": [
                      "iban",
                      "name"
                    ]
                  }
                },
                "required": [
                  "instructedAmount",
                  "transactionID",
                  "purpose",
                  "creditorAccount"
                ]
              }
            },
            {
              "id": "issuer",
              "path": [
                "$.iss"
              ],
              "filter": {
                "type": "string",
                "const": "did:example:sd5sde"
              }
            },
            {
              "id": "subject",
              "path": [
                "$.sub"
              ],
              "filter": {
                "type": "string",
                "const": "did:example:sd5sde"
              }
            }
          ]
        }
      }
    ]
  },
  "response_mode": "direct_post",
  "response_type": "vp_token",
  "response_uri": "https://bank.com/verifier/present",
  "state": "DUcDuyi8efXwAsB6"
}

```

Example of a UI form rendered dynamically by the wallet[^js_an_example]:

![Dynamic form generation](dynamic-form.png)


Example of a self-attested payment request credential:

```json
{
  "iss": "did:jwk:eyJrdHkiOiJFi...",
  "jti": "dc961165-fb13-4d19-98f0-37c9bb06be",
  "nbf": 1707232027,
  "aud": "EUDIW",
  "nonce": "a2bcc3e0-623d-441d-aa80-31d82aa665d1",
  "sub": "did:jwk:eyJrdHkiOiJFi...",
  "vc": {
    "@context": [
      "https://www.w3.org/2018/credentials/v1",
      "https://w3id.org/security/suites/jws-2020/v1"
    ],
    "type": [
      "VerifiableCredential",
      "Request2Sign",
      "PaymentRequest"
    ],
    "credentialSubject": {
        "request2sign_payload" : {
          "instructedAmount": {
             "currency": "EUR",
             "amount": "123.50"
          },
          "creditorName": "Merchant A",
          "creditorAccount": {
             "iban": "DE02100100109307118603"
          },
          "remittanceInformationUnstructured": "Ref Number Merchant"
       }
    }
  }
}

```

#### Payment Status

```mermaid

sequenceDiagram
    autonumber
    participant payer as Payer
    participant uw as EUDIW Wallet
    participant payee as Payee
    participant pisp as PISP
    participant bank as ASPSP Payer
    
    pisp ->> bank: Payment status request
    bank ->> pisp: Payment status response
    pisp ->> payee: Payment status
    payee ->> payer: Payment status

```

1. The PISP polls the status of the payment using OpenBanking APIs. Alternativly this might also be done using a dedicated callback if offered by the ASPSP.
2. The ASPSP communicates the status of the payment to the PISP.
3. The PISP communicates the status of the payment to the payee.
4. The PISP communicates the status of the payment to the payer.


[^xs2a]: [NextGenPSD2 XS2A Framework Implementation Guidelines](https://www.berlin-group.org/_files/ugd/c2914b_fec1852ec9c640568f5c0b420acf67d2.pdf)
[^r2s]:[Request to sign based on OpenID4VP](openid4vp-r2s.md)
[^openid4vp]: [OpenID4VP - draft 20](https://openid.net/specs/openid-4-verifiable-presentations-1_0.html)
[^openid4vci]: [OpenID4VCI - draft 13](https://openid.net/specs/openid-4-verifiable-credential-issuance-1_0.html)
[^did]:[Decentralized Identifiers - DIDs v1.0](https://www.w3.org/TR/did-core/)
[^js_an_example]: [Example dynamic form generation based on JSON Schema](https://rjsf-team.github.io/react-jsonschema-form/#eyJmb3JtRGF0YSI6eyJpbnN0cnVjdGVkQW1vdW50Ijp7ImFtb3VudCI6IjUuNTkiLCJjdXJyZW5jeSI6IkVVUiJ9LCJ0cmFuc2FjdGlvbklEIjoiQ0RGODM0RjQtNUNGNC00QTI3LTlDMDQtOUVFQjM0N0JGIiwicHVycG9zZSI6IlNob3BwaW5nIHNvbWV3aGVyZSIsImNyZWRpdG9yQWNjb3VudCI6eyJpYmFuIjoiREU4ODk0MDU5NDIxMDAyMDgwMTg5MCIsIm5hbWUiOiJNZXJjaGFudCBBIn19LCJzY2hlbWEiOnsiJHNjaGVtYSI6Imh0dHA6Ly9qc29uLXNjaGVtYS5vcmcvZHJhZnQtMDQvc2NoZW1hIyIsInR5cGUiOiJvYmplY3QiLCJwcm9wZXJ0aWVzIjp7Imluc3RydWN0ZWRBbW91bnQiOnsidHlwZSI6Im9iamVjdCIsInRpdGxlIjoiQW1vdW50IiwicHJvcGVydGllcyI6eyJhbW91bnQiOnsidHlwZSI6InN0cmluZyIsInRpdGxlIjoiQW1vdW50IiwiZGVzY3JpcHRpb24iOiJBbW91bnQgdG8gcGF5In0sImN1cnJlbmN5Ijp7InR5cGUiOiJzdHJpbmciLCJ0aXRsZSI6IkN1cnJlbmN5IiwiZGVzY3JpcHRpb24iOiJDdXJyZW5jeSB0byBwYXkgaW4ifX0sInJlcXVpcmVkIjpbImFtb3VudCIsImN1cnJlbmN5Il19LCJ0cmFuc2FjdGlvbklEIjp7InR5cGUiOiJzdHJpbmciLCJ0aXRsZSI6IlRyYW5zYWN0aW9uIElEIiwiZGVzY3JpcHRpb24iOiJVbmlxdWUgdHJhbnNhY3Rpb24gaWRlbnRpZmllciJ9LCJwdXJwb3NlIjp7InR5cGUiOiJzdHJpbmciLCJ0aXRsZSI6IlB1cnBvc2UiLCJkZXNjcmlwdGlvbiI6IlB1cnBvc2Ugb2YgdGhlIHRyYW5zYWN0aW9uIn0sImNyZWRpdG9yQWNjb3VudCI6eyJ0eXBlIjoib2JqZWN0IiwidGl0bGUiOiJDcmVkaXRvciIsInByb3BlcnRpZXMiOnsiaWJhbiI6eyJ0eXBlIjoic3RyaW5nIiwidGl0bGUiOiJJQkFOIiwiZGVzY3JpcHRpb24iOiJJQkFOIG9mIHRoZSBjcmVkaXRvciJ9LCJuYW1lIjp7InR5cGUiOiJzdHJpbmciLCJ0aXRsZSI6Ik5hbWUiLCJkZXNjcmlwdGlvbiI6Ik5hbWUgb2YgdGhlIGNyZWRpdG9yIn19LCJyZXF1aXJlZCI6WyJpYmFuIiwibmFtZSJdfX0sInJlcXVpcmVkIjpbImluc3RydWN0ZWRBbW91bnQiLCJ0cmFuc2FjdGlvbklEIiwicHVycG9zZSIsImNyZWRpdG9yQWNjb3VudCJdfSwidWlTY2hlbWEiOnsiZmlyc3ROYW1lIjp7InVpOmF1dG9mb2N1cyI6dHJ1ZSwidWk6ZW1wdHlWYWx1ZSI6IiIsInVpOnBsYWNlaG9sZGVyIjoidWk6ZW1wdHlWYWx1ZSBjYXVzZXMgdGhpcyBmaWVsZCB0byBhbHdheXMgYmUgdmFsaWQgZGVzcGl0ZSBiZWluZyByZXF1aXJlZCIsInVpOmF1dG9jb21wbGV0ZSI6ImZhbWlseS1uYW1lIiwidWk6ZW5hYmxlTWFya2Rvd25JbkRlc2NyaXB0aW9uIjp0cnVlLCJ1aTpkZXNjcmlwdGlvbiI6Ik1ha2UgdGV4dCAqKmJvbGQqKiBvciAqaXRhbGljKi4gVGFrZSBhIGxvb2sgYXQgb3RoZXIgb3B0aW9ucyBbaGVyZV0oaHR0cHM6Ly9tYXJrZG93bi10by1qc3gucXVhbnRpem9yLmRldi8pLiJ9LCJsYXN0TmFtZSI6eyJ1aTphdXRvY29tcGxldGUiOiJnaXZlbi1uYW1lIiwidWk6ZW5hYmxlTWFya2Rvd25JbkRlc2NyaXB0aW9uIjp0cnVlLCJ1aTpkZXNjcmlwdGlvbiI6Ik1ha2UgdGhpbmdzICoqYm9sZCoqIG9yICppdGFsaWMqLiBFbWJlZCBzbmlwcGV0cyBvZiBgY29kZWAuIDxzbWFsbD5BbmQgdGhpcyBpcyBhIHNtYWxsIHRleHRzLjwvc21hbGw+ICJ9LCJhZ2UiOnsidWk6d2lkZ2V0IjoidXBkb3duIiwidWk6dGl0bGUiOiJBZ2Ugb2YgcGVyc29uIiwidWk6ZGVzY3JpcHRpb24iOiIoZWFydGggeWVhcikifSwiYmlvIjp7InVpOndpZGdldCI6InRleHRhcmVhIn0sInBhc3N3b3JkIjp7InVpOndpZGdldCI6InBhc3N3b3JkIiwidWk6aGVscCI6IkhpbnQ6IE1ha2UgaXQgc3Ryb25nISJ9LCJ0ZWxlcGhvbmUiOnsidWk6b3B0aW9ucyI6eyJpbnB1dFR5cGUiOiJ0ZWwifX19LCJ0aGVtZSI6ImRlZmF1bHQiLCJsaXZlU2V0dGluZ3MiOnsic2hvd0Vycm9yTGlzdCI6InRvcCIsInZhbGlkYXRlIjpmYWxzZSwiZGlzYWJsZWQiOmZhbHNlLCJub0h0bWw1VmFsaWRhdGUiOmZhbHNlLCJyZWFkb25seSI6dHJ1ZSwib21pdEV4dHJhRGF0YSI6ZmFsc2UsImxpdmVPbWl0IjpmYWxzZSwiZXhwZXJpbWVudGFsX2RlZmF1bHRGb3JtU3RhdGVCZWhhdmlvciI6eyJhcnJheU1pbkl0ZW1zIjoicG9wdWxhdGUiLCJhbGxPZiI6InNraXBEZWZhdWx0cyIsImVtcHR5T2JqZWN0RmllbGRzIjoicG9wdWxhdGVBbGxEZWZhdWx0cyJ9fX0=)
